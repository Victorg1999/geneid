#!/bin/bash

# revisa els dos fitxers donats com a parametre (se suposa que ambdos
# son sortida de "md5dir") per veure si son iguals
#
# donat que no tenen perque tenir la mateixa ordenacio degut als noms que
# canvien de majuscules a minuscules i vice versa, assumim que dos fitxers
# amb el mateix md5 son iguals, independentment del nom
#
# per tant, fem "cut" del md5 de cada fitxer, ordenem alfabeticament,
# i comparem. la posicio des de la que s'ha de fer el cut depen de l'amplada
# de l'arbre (profunditat de directoris i longitud del nom), aixi que s'ha
# de calcular

if [ $# != 2 ]
then
   echo Necessito dos parametres
   exit
elif [ ! -s "$1" ]
then
   echo $1 no existeix
   exit
elif [ ! -s "$2" ]
then
   echo $2 no existeix
   exit
fi

fit1=$1
fit2=$2

typeset -i md5pos1 md5pos2

md5pos1=1
while [ "`head -1 \"$fit1\" | cut -c$md5pos1-`" != md5sum ]
do
   let md5pos1=md5pos1+1
done
let md5pos1=md5pos1-13
cat "$fit1" | cut -c$md5pos1- | grep -v ^-$ | sort > /tmp/md5.1

md5pos2=1
while [ "`head -1 \"$fit2\" | cut -c$md5pos2-`" != md5sum ]
do
   let md5pos2=md5pos2+1
done
let md5pos2=md5pos2-13
cat "$fit2" | cut -c$md5pos2- | grep -v ^-$ | sort > /tmp/md5.2

diff /tmp/md5.[12] | egrep "^[<>]" | cut -c3- >/tmp/md5.3
grep -f /tmp/md5.3 "$fit1" "$fit2"

rm /tmp/md5.[123]
