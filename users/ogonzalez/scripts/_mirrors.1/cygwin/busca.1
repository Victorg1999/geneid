#!/usr/bin/perl

# fa un llistat del contingut de cada directori eliminant allo que
# s'hauria d'esborrar, per veure si hi ha versions noves

sub indent {
   $_[0] =~ s#[^ /]+/#   #g;
   $_[0] =~ /^ */;
   $indent=$&;
   return ($_[0],$indent);
}

@nou=<STDIN>;

open(fit,"/home/ug/ogonzalez/scripts/_mirrors.1/cygwin/vells.lst");
@vell=<fit>;
close(fit);

for ($i=0;$i<=$#nou;$i++) {
   $nou[$i] =~ s/\*$//;
   if ( $nou[$i] =~ /(\/|md5.sum|setup.hint)$/ || $nou[$i] =~ /^$/ ) {
      splice(@nou,$i,1);
      $i--;
   }
}

for ($j=0;$j<=$#vell;$j++) {
   if ( $vell[$j] !~ /^--/ ) {
      splice(@vell,$j,1);
      $j--;
   } else {
      if ( $vell[$j] =~ /^--(md5.sum|setup.hint)$/ ) {
         splice(@vell,$j,1);
         $j--;
      } else {
         $vell[$j] =~ s/^--//;
      }
   }
}

for ($i=0;$i<=$#nou;$i++) {
   if ( $nou[$i] !~ /[:]$/ ) {
      $trobat=0;
      for ($j=0;$j<=$#vell;$j++) {
         if ( $nou[$i] =~ /^$vell[$j]/ ) {
            splice(@vell,$j,1);
            $trobat=1;
            last;
         }
      }
      $parcial[$#parcial+1]="$ind   $nou[$i]" if ( $trobat == 0 );
   } else {
      if ( $#parcial > 1 ) {
         print "$directori";
         print @parcial;
      } elsif ( $#parcial == 1 ) {
         $tmp1=$parcial[0];
         $tmp2=$parcial[1];
         chop($tmp1);
         chop($tmp2);
         $tmp1 =~ s/.tar.[bg]z2?$//;
         $tmp2 =~ s/.tar.[bg]z2?$//;
         $tmp1 =~ s/$tmp2//;
         if ( $tmp1 ne "-src" ) {
            print "$directori";
            print @parcial;
         }
      }
      ($directori,$ind)=indent($nou[$i]);
      $#parcial=-1;
   }
}

print "\n--- Entrades a vells.lst que corresponen a fitxers esborrats:\n\n";
print @vell;
