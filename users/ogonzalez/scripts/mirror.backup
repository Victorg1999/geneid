#!/usr/bin/perl

# la idea es fer el "download" amb wget i aprofitar els .listing per
# esborrar allo que ja no es troba al servidor
#
# en acabar, eliminem els .listing perque ja no serveixen per res
#
# la rutina funciona de manera recursiva des del directori actual

use File::Path;

sub direc {
   my $RUTA="$_[0]$_[1]";
   my $nom;
   my @listing;
   my %hores;
   chdir("$_[1]");
   opendir(DIR,".");
   my @dirlist=sort(grep(!/^(\.|\.\.|\.listing)$/,readdir(DIR)));
   closedir(DIR);
   if ( -e ".listing" ) {
      # no sempre hi ha .listing, pero si hi es fem neteja
      open(FIT,".listing");
      while (<FIT>) {
         next if ( /(^total| \.\.?$)/ );
         chomp;
         @tmp=split(/\s+/og,$_);
         push(@listing,$tmp[8]);
         $mes=$mesos{$tmp[5]};
         $dia=substr("0$tmp[6]",length($tmp[6])-1,2);
         $extra=$tmp[7];
         if ( $extra =~ /:/ ) {
            # es de l'any actual i ve en format mes dia hora
            $extra =~ s/://;
            $hora="$mes$dia$extra.00";
         } else {
            # es antic i ve en format mes dia any
            $hora="$extra$mes${dia}1200.00";
         }
         $hores{"$tmp[8]"}=$hora;
      }
      close(FIT);
      for (my $index=0;$index<=$#dirlist;$index++) {
         print "\b"x20;
         print "$index/$#dirlist";
         $nom=$dirlist[$index];
         if ( $nom =~ /[^A-Za-z0-9_\-\.]/ ) {
            print "ATENCIO: \"$nom\" a \"$RUTA\"\n"; # no vull sorpreses...
            if ( grep(/^$nom$/,@listing) ) {
               print "   (no esborrar...)\n";
            } else {
               print "   (esborrar...)\n";
            }
            next;
         }
         if ( grep(/^$nom$/,@listing) ) {
#           print STDERR ".";
            # com que de vegades no posa l'hora que correspon,
            # la poso jo manualment. he de pulir aixo.
            system("touch -t $hores{$nom} $nom");
            if ( -d "$nom" ) {
               print "\n";
               &direc("$RUTA/",$nom);
            }
         } else {
#           print STDERR "d";
            if ( $neteja ) {
               print " - Eliminant $RUTA/$nom\n";
               rmtree("$nom");
            } else {
               print " - Trobat $RUTA/$nom\n";
            }
         }
      }
      print "\n";
#     unlink(".listing");
   } else {
      # ens limitem a entrar en els subdirectoris
      foreach $nom (@dirlist) {
         if ( -d "$nom" ) {
            &direc("$RUTA/",$nom);
         }
      }
   }
   chdir("..");
}

$mesos{"Jan"}="01";
$mesos{"Feb"}="02";
$mesos{"Mar"}="03";
$mesos{"Apr"}="04";
$mesos{"May"}="05";
$mesos{"Jun"}="06";
$mesos{"Jul"}="07";
$mesos{"Aug"}="08";
$mesos{"Sep"}="09";
$mesos{"Oct"}="10";
$mesos{"Nov"}="11";
$mesos{"Dec"}="12";
$neteja=( $ARGV[1] eq "-n" );
&direc("",$ARGV[0]);

