% -*- mode: Noweb; noweb-code-mode: perl-mode; tab-width: 4 -*-
\documentclass[11pt]{article}
%
%2345678901234567890123456789012345678901234567890123456789012345678901234567890
%        1         2         3         4         5         6         7         8
%
% # $Id: blat2gff.tex,v 1.1 2001-10-22 14:44:13 jabril Exp $ 
%
\usepackage{noweb}
\usepackage[a4paper,offset={0pt,0pt},hmargin={2cm,2cm},vmargin={1cm,1cm}]{geometry}
\usepackage{graphics}
\usepackage[dvips]{graphicx}
%% pstricks
\usepackage[dvips]{pstcol}
\usepackage{pstricks}
%\usepackage{pst-node}
%\usepackage{pst-char}
%\usepackage{pst-grad}
%% bibliography
\usepackage{natbib}
%% latex2html
\usepackage{url}
\usepackage{html}     
\usepackage{htmllist} 
%% tables    
\usepackage{dcolumn}
%\usepackage{colortbl}
%\usepackage{multirow}
%\usepackage{hhline}
%\usepackage{tabularx}
%% seminar
%\usepackage{semcolor,semlayer,semrot,semhelv,sem-page,slidesec}
%% draft watermark
%\usepackage[all,dvips]{draftcopy}
%\draftcopySetGrey{0.9}
%\draftcopyName{CONFIDENTIAL}{100}
%% layout
\usepackage{fancyhdr} % Do not use \usepackage{fancybox} -> TOCs disappear
%\usepackage{lscape}
%\usepackage{rotating}
%\usepackage{multicol}
%% fonts
\usepackage{times}\fontfamily{ptm}\selectfont
\usepackage{t1enc}

% noweb options
\noweboptions{smallcode}
\def\nwendcode{\endtrivlist \endgroup} % relax page breaking scheme
\let\nwdocspar=\par                    %

\input defs.tex % from <LaTeX new definitions> chunk

%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
\begin{document}
%
\nwfilename{/home/ug/jabril/development/softjabril/blat2gff/blat2gff.nw}%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
%
\nwbegindocs{2}\nwdocspar

\nwenddocs{}%
\nwbegindocs{4}\nwdocspar
\nwenddocs{}%
\nwbegindocs{6}\nwdocspar
\nwenddocs{}%
\nwbegindocs{8}\nwdocspar
\nwenddocs{}%
\nwbegindocs{10}\nwdocspar
\nwenddocs{}%
\nwbegindocs{12}\nwdocspar

\thispagestyle{empty}

\begin{titlepage}

\ \vfill
\begin{center}
\begin{bfseries}
\begin{large}
\newlength{\lttbl}\setlength{\lttbl}{0.25\linewidth}
\newlength{\rttbl}\setlength{\rttbl}{0.70\linewidth}
%\fbox{
%\vskip 2ex
\begin{tabular}{>{\scshape}r@{\quad}l}
\rule{\lttbl}{0pt} & \rule{\rttbl}{0pt} \\[2ex]
\multicolumn{2}{c}{\shortstack{\rule[0ex]{0.95\linewidth}{2pt}\\[0ex]
                               \rule[1ex]{0.95\linewidth}{2pt}}}\\[2ex]
Program Name: & {\Huge\progname}                       \\[3ex]
\multicolumn{2}{c}{\rule[0.5ex]{0.95\linewidth}{2pt}}\\[2ex]
      Author: & {\Large
                 \begin{minipage}[t]{0.95\rttbl}
                 \authorslist
                 \end{minipage}}                       \\[2ex]
     License: & {\license}                             \\[2ex]
 Last Update: & {\today}                               \\[2ex]
 Description: & {\large\mdseries
                 \begin{minipage}[t]{0.95\rttbl}
                 \progdesc
                 \end{minipage}}                       \\[2ex]
\\
\multicolumn{2}{c}{\shortstack{\rule[0ex]{0.95\linewidth}{2pt}\\[0ex]
                               \rule[1ex]{0.95\linewidth}{2pt}}}\\[2ex]
\end{tabular}
%} % fbox
\end{large}
\end{bfseries}
\end{center}

\vfill

\begin{raggedleft}
\showaffiliation
\end{raggedleft}

\end{titlepage} %'

%
%%%%%%%%%%%%%%%%%%%% FRONTMATTER

\newpage %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\pagenumbering{roman}
\setcounter{page}{1}
\pagestyle{fancy}
% Marks redefinition must go here because pagestyle 
% resets the values to the default ones.
\renewcommand{\sectionmark}[1]{\markboth{}{\thesection.\ #1}}
\renewcommand{\subsectionmark}[1]{\markboth{}{\thesubsection.\ \textsl{#1}}}

\tableofcontents
\listoftables
\listoffigures

\vfill
\begin{center}
{\small$<$ \verb$Id: blat2gff.tex,v 1.1 2001-10-22 14:44:13 jabril Exp $$>$ }
\end{center}

%%%%%%%%%%%%%%%%%%%% MAINMATTER

\newpage %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\pagenumbering{arabic}
\setcounter{page}{1}

\sctn{Introduction}

\subsctn{Program description}

\subsctn{Input}

\nwenddocs{}\nwbegincode{13}\sublabel{NWblax-BLAJ-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-BLAJ-1}}}\moddef{BLAT output example~{\nwtagstyle{}\subpageref{NWblax-BLAJ-1}}}\endmoddef
39  9   0   0   0   0   0   0   ++  Hsap_BTK    78931   61871   61919   ~/Research/HomologyProgs/wublast-blat/tests/homologydb/blat/raw/Mmus_BTK.nib    88871   64087   64135   1   48, 61871,  64087,
36  6   0   0   0   0   0   0   ++  Hsap_BTK    78931   61867   61909   ~/Research/HomologyProgs/wublast-blat/tests/homologydb/blat/raw/Mmus_BTK.nib    88871   64087   64129   1   42, 61867,  64087,
1940    181 0   0   4   87  5   96  -+  Hsap_BTK    78931   66352   68560   ~/Research/HomologyProgs/wublast-blat/tests/homologydb/blat/raw/Mmus_BTK.nib    88871   16106   18323   7   185,103,50,41,224,63,1455,  10371,10556,10663,10714,10755,11019,11124,  16106,16294,16404,16454,16496,16766,16868,
212 26  0   0   0   0   0   0   -+  Hsap_BTK    78931   11174   11412   ~/Research/HomologyProgs/wublast-blat/tests/homologydb/blat/raw/Mmus_BTK.nib    88871   72680   72918   1   238,    67519,  72680,
406 68  0   0   1   207 1   202 +-  Hsap_BTK    78931   62134   62815   ~/Research/HomologyProgs/wublast-blat/tests/homologydb/blat/raw/Mmus_BTK.nib    88871   21775   22451   2   165,309,    62134,62506,    66420,66787,
238 28  0   0   0   0   0   0   +-  Hsap_BTK    78931   10446   10712   ~/Research/HomologyProgs/wublast-blat/tests/homologydb/blat/raw/Mmus_BTK.nib    88871   73544   73810   1   266,    10446,  15061,
33  0   0   0   0   0   0   0   --  Hsap_BTK    78931   22065   22098   ~/Research/HomologyProgs/wublast-blat/tests/homologydb/blat/raw/Mmus_BTK.nib    88871   75119   75152   1   33, 56833,  13719,
33  0   0   0   0   0   0   0   --  Hsap_BTK    78931   22081   22114   ~/Research/HomologyProgs/wublast-blat/tests/homologydb/blat/raw/Mmus_BTK.nib    88871   75111   75144   1   33, 56817,  13727,
\nwnotused{BLAT\ output\ example}\nwendcode{}\nwbegindocs{14}\nwdocspar

\subsctn{Output}

% \subsctn{Comments}

\subsctn{To Do}

\begin{itemize}
 \input todo.tex
\end{itemize}

\newpage %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\sctn{Implementation}

\nwenddocs{}\nwbegincode{15}\sublabel{NWblax-ProC-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-ProC-1}}}\moddef{Program Info~{\nwtagstyle{}\subpageref{NWblax-ProC-1}}}\endmoddef
my $PROGRAM = 'blat2gff.pl';
my $VERSION = '0.1_alpha';
\nwused{\\{NWblax-PERC-1}}\nwendcode{}\nwbegindocs{16}\nwdocspar

\nwenddocs{}\nwbegincode{17}\sublabel{NWblax-ProJ-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-ProJ-1}}}\moddef{Program Description~{\nwtagstyle{}\subpageref{NWblax-ProJ-1}}}\endmoddef
# #----------------------------------------------------------------#
# #                          blat2gff.pl                           #
# #----------------------------------------------------------------#
# 
#    blat2gff.pl [options] <files>
#
#    Remember to put a short description of your script here...
# 
#     Copyright (C) 2001 - Josep Francesc ABRIL FERRANDO  
\nwused{\\{NWblax-PERC-1}}\nwendcode{}\nwbegindocs{18}\nwdocspar

\subsctn{Program outline}

\nwenddocs{}\nwbegincode{19}\sublabel{NWblax-bla8-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-bla8-1}}}\moddef{blat2gff~{\nwtagstyle{}\subpageref{NWblax-bla8-1}}}\endmoddef
\LA{}PERL shebang~{\nwtagstyle{}\subpageref{NWblax-PERC-1}}\RA{}
#
# MODULES
#
\LA{}Use Modules~{\nwtagstyle{}\subpageref{NWblax-UseB-1}}\RA{}
#
# VARIABLES
#
\LA{}Global Vars~{\nwtagstyle{}\subpageref{NWblax-GloB-1}}\RA{}
#
# MAIN LOOP
#
\LA{}Main Loop~{\nwtagstyle{}\subpageref{NWblax-Mai9-1}}\RA{}
#
# FUNCTIONS
#
\LA{}Functions~{\nwtagstyle{}\subpageref{NWblax-Fun9-1}}\RA{}
\nwnotused{blat2gff}\nwendcode{}\nwbegindocs{20}\nwdocspar

\nwenddocs{}\nwbegincode{21}\sublabel{NWblax-UseB-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-UseB-1}}}\moddef{Use Modules~{\nwtagstyle{}\subpageref{NWblax-UseB-1}}}\endmoddef
\nwused{\\{NWblax-bla8-1}}\nwendcode{}\nwbegindocs{22}\nwdocspar

\nwenddocs{}\nwbegincode{23}\sublabel{NWblax-GloB-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-GloB-1}}}\moddef{Global Vars~{\nwtagstyle{}\subpageref{NWblax-GloB-1}}}\endmoddef
my @frame = (3,1,2);
my %blat = (
    STRAND =>  8,
    Q_NAME =>  9,
    Q_LEN  => 10,
    Q_ORI  => 11,
    Q_END  => 12,
    T_NAME => 13,
    T_LEN  => 14,
    T_ORI  => 15,
    T_END  => 16,
    B_NUM  => 17,
    B_LEN  => 18,
    B_QPOS => 19,
    B_TPOS => 20,
    );
my %gff = ();
my $maxfields = 21;
my %group = ();
my ($group_cnt, $rec_cnt) = (0) x 2;
\nwalsodefined{\\{NWblax-GloB-2}}\nwused{\\{NWblax-bla8-1}}\nwendcode{}\nwbegindocs{24}\nwdocspar

\nwenddocs{}\nwbegincode{25}\sublabel{NWblax-Mai9-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-Mai9-1}}}\moddef{Main Loop~{\nwtagstyle{}\subpageref{NWblax-Mai9-1}}}\endmoddef
while (<STDIN>) \{
    my @f = ();
    next unless /^\\d/o;
    chomp;
    @f = split /\\s+/og, $_;
    do \{ # ensure that there are 21 fields
        print STDERR "### NOT enough fields for this record:\\n##### @f \\n";
        next;
    \} unless scalar(@f) == $maxfields;
    %gff = ();
    ++$rec_cnt;
    $f[$blat\{STRAND\}] =~ /(.)(.)/og && 
        ($gff\{Q_STRAND\} = $1, $gff\{T_STRAND\} = $2);
    do \{ # ensure that strands are +/- 
        print STDERR "### CANNOT find strand for this record:\\n##### @f \\n";
        next;
    \} unless ($gff\{Q_STRAND\} =~ /[+-]/o && $gff\{T_STRAND\} =~ /[+-]/o);   
    $f[$blat\{Q_NAME\}] =~ m\{/?([^/]+)$\}og && ($gff\{Q_NAME\} = $1) ;
    $f[$blat\{T_NAME\}] =~ m\{/?([^/]+)$\}og && ($gff\{T_NAME\} = $1) ;
    defined($group\{"$gff\{T_NAME\}.$gff\{T_STRAND\}"\}) || 
        ($group\{"$gff\{T_NAME\}.$gff\{T_STRAND\}"\} = ++$group_cnt);
    $gff\{GROUP\} = $group\{"$gff\{T_NAME\}.$gff\{T_STRAND\}"\};
    $gff\{Q_LEN\} = $f[$blat\{Q_LEN\}]; # seq lengths are OK
    $gff\{T_LEN\} = $f[$blat\{T_LEN\}];
    $gff\{Q_ORI\} = $f[$blat\{Q_ORI\}] + 1; # HSP coords start at 0, not at 1
    $gff\{Q_END\} = $f[$blat\{Q_END\}] + 1;
    $gff\{T_ORI\} = $f[$blat\{T_ORI\}] + 1;
    $gff\{T_END\} = $f[$blat\{T_END\}] + 1;
    $gff\{Q_FRAME\} =
        &get_frame($gff\{Q_STRAND\}, $gff\{Q_LEN\}, $gff\{Q_ORI\}, $gff\{Q_END\});
    $gff\{T_FRAME\} = 
        &get_frame($gff\{T_STRAND\}, $gff\{T_LEN\}, $gff\{T_ORI\}, $gff\{T_END\});
    $gff\{B_NUM\} = $f[$blat\{B_NUM\}];
    @\{ $gff\{B_LEN\} \}  = split /,/og, $f[$blat\{B_LEN\}];
    @\{ $gff\{B_QPOS\} \} = split /,/og, $f[$blat\{B_QPOS\}];
    @\{ $gff\{B_TPOS\} \} = split /,/og, $f[$blat\{B_TPOS\}];
    printf STDOUT "# ".$GFFstring,
        $gff\{Q_NAME\}, "BLAT","$gff\{Q_LEN\}:$gff\{T_LEN\}", 
            $gff\{Q_ORI\}, $gff\{Q_END\}, 0, $gff\{Q_STRAND\}, $gff\{Q_FRAME\},
        "$gff\{T_NAME\}.$gff\{GROUP\}.$rec_cnt",
            $gff\{T_ORI\}, $gff\{T_END\}, $gff\{T_STRAND\}, $gff\{T_FRAME\};
    &loop_HSPs($rec_cnt);
\}; # while read input

exit(0);
\nwused{\\{NWblax-bla8-1}}\nwendcode{}\nwbegindocs{26}\nwdocspar

\nwenddocs{}\nwbegincode{27}\sublabel{NWblax-Fun9-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-Fun9-1}}}\moddef{Functions~{\nwtagstyle{}\subpageref{NWblax-Fun9-1}}}\endmoddef
sub get_frame() \{
    my ($strand,$len,$ori,$end) = @_;
    if ($strand eq '-') \{
       return $frame[(($len - $end + 1) % 3)];
    \} else \{
       return $frame[($ori % 3)];
    \}
\} # get_frame
sub get_hsp() \{
    my ($s,$L,$l,$n) = @_;
    my ($o,$e);
    if ($s eq '-') \{
        $e = $L - $n;
        $o = $e - $l
    \} else \{
        $o = $n;
        $e = $o + $l;
    \};
    $o++; $e++; # HSP coords start at 0, not at 1
    return ($o, $e, &get_frame($s,$L,$o,$e));
\} # get_hsp
\nwalsodefined{\\{NWblax-Fun9-2}}\nwused{\\{NWblax-bla8-1}}\nwendcode{}\nwbegindocs{28}\nwdocspar

\nwenddocs{}\nwbegincode{29}\sublabel{NWblax-GloB-2}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-GloB-2}}}\moddef{Global Vars~{\nwtagstyle{}\subpageref{NWblax-GloB-1}}}\plusendmoddef
# GetSRsAln.pl like:
#$srs->\{QUERY\}\\t$blst_prg\\tsr\\t$srs->\{START_Q\}\\t$srs->\{END_Q\}
#\\t$srs->\{SCORE\}\\t$srs->\{STRAND_Q\}\\t$srs->\{FRAME_Q\}
#\\tTarget \\"$srs->\{SUBJECT\}\\"\\t$srs->\{START_S\}\\t$srs->\{END_S\}
#\\tE_value $srs->\{E_VALUE\}\\tStrand $srs->\{STRAND_S\}
#\\tFrame $srs->\{FRAME_S\}\\t\\#Projection $srs->\{PROJECTION\} 
my $GFFstring = ("\\%s\\t" x 8).'Target "%s"'.
       "\\t\\%s\\t\\%s\\tE_Value .\\tStrand \\%s\\tFrame \\%s\\n";
\nwendcode{}\nwbegindocs{30}\nwdocspar
\nwenddocs{}\nwbegincode{31}\sublabel{NWblax-Fun9-2}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-Fun9-2}}}\moddef{Functions~{\nwtagstyle{}\subpageref{NWblax-Fun9-1}}}\plusendmoddef
sub loop_HSPs() \{
    my ($num) = @_;
    my ($c,$l,$q,$t,$qo,$qe,$qf,$to,$te,$tf);
    for ($c = 0; $c < $gff\{B_NUM\}; $c++) \{
        $l = $gff\{B_LEN\}[$c];
        $q = $gff\{B_QPOS\}[$c];
        $t = $gff\{B_TPOS\}[$c];
        ($qo,$qe,$qf) = &get_hsp($gff\{Q_STRAND\},$gff\{Q_LEN\},$l,$q);
        ($to,$te,$tf) = &get_hsp($gff\{T_STRAND\},$gff\{T_LEN\},$l,$t);
        printf STDOUT $GFFstring,
            $gff\{Q_NAME\}, "blat", "hsp", $qo, $qe, 0, $gff\{Q_STRAND\}, $qf,
            "$gff\{T_NAME\}.$gff\{GROUP\}.$num", $to, $te, $gff\{T_STRAND\}, $tf;
    \}; # for
\} # loop_HSPs
\nwendcode{}\nwbegindocs{32}\nwdocspar

\label{todo:AAA}\label{todo:AAB}
\nwenddocs{}%
%
%
\nwbegindocs{34}\nwdocspar
\nwenddocs{}%
%
%
\nwbegindocs{36}\nwdocspar
\todo{
 \item \todoAAA
 \item \todoAAB
 } % todo

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{comment}
\end{comment}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%% BACKMATTER

% \newpage %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% 
% \bibliographystyle{apalike}
% \bibliography{/home1/rguigo/docs/biblio/References}

\newpage %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\appendix

\sctn{empty appendix section}

\subsctn{empty appendix subsection}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{comment}
\end{comment}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%
\newpage %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\sctn{Common code blocks}

\subsctn{PERL scripts}

\nwenddocs{}\nwbegincode{37}\sublabel{NWblax-PERC-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-PERC-1}}}\moddef{PERL shebang~{\nwtagstyle{}\subpageref{NWblax-PERC-1}}}\endmoddef
#!/usr/bin/perl -w
# This is perl, version 5.005_03 built for i386-linux
#
\LA{}Program Description~{\nwtagstyle{}\subpageref{NWblax-ProJ-1}}\RA{}
#
\LA{}GNU License~{\nwtagstyle{}\subpageref{NWblax-GNUB-1}}\RA{}
#
\LA{}Version Control Id Tag~{\nwtagstyle{}\subpageref{NWblax-VerM-1}}\RA{}
#
use strict;
#
\LA{}Program Info~{\nwtagstyle{}\subpageref{NWblax-ProC-1}}\RA{}
my $DATE = localtime;
my $USER = defined($ENV\{USER\}) ? $ENV\{USER\} : 'Child Process';
my $host = `hostname`;
chomp($host);
#
\nwused{\\{NWblax-bla8-1}}\nwendcode{}\nwbegindocs{38}\nwdocspar

\nwenddocs{}\nwbegincode{39}\sublabel{NWblax-GloQ-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-GloQ-1}}}\moddef{Global Constants - Boolean~{\nwtagstyle{}\subpageref{NWblax-GloQ-1}}}\endmoddef
my ($T,$F) = (1,0); # for 'T'rue and 'F'alse
\eatline
\nwnotused{Global\ Constants\ -\ Boolean}\nwendcode{}\nwbegindocs{40}\nwdocspar

\subsubsctn{Timing our scripts}

The '{\tt{}Benchmark}' module encapsulates a number of routines to help to figure out how long it takes to execute a piece of code and the whole script.

\nwenddocs{}\nwbegincode{41}\sublabel{NWblax-UseN-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-UseN-1}}}\moddef{Use Modules - Benchmark~{\nwtagstyle{}\subpageref{NWblax-UseN-1}}}\endmoddef
use Benchmark;
  \LA{}Timer ON~{\nwtagstyle{}\subpageref{NWblax-Tim8-1}}\RA{}
\nwnotused{Use\ Modules\ -\ Benchmark}\nwendcode{}\nwbegindocs{42}\nwdocspar

See '{\tt{}man\ Benchmark}' for further info about this package. 
We set an array to keep record of timing for each section.

\nwenddocs{}\nwbegincode{43}\sublabel{NWblax-Tim8-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-Tim8-1}}}\moddef{Timer ON~{\nwtagstyle{}\subpageref{NWblax-Tim8-1}}}\endmoddef
my @Timer = (new Benchmark);
\nwused{\\{NWblax-UseN-1}}\nwendcode{}\nwbegindocs{44}\nwdocspar

\nwenddocs{}\nwbegincode{45}\sublabel{NWblax-ComS-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-ComS-1}}}\moddef{Common PERL subs - Benchmark~{\nwtagstyle{}\subpageref{NWblax-ComS-1}}}\endmoddef
sub timing() \{
    push @Timer, (new Benchmark);
    # partial time 
    $_[0] || 
        (return timestr(timediff($Timer[$#Timer],$Timer[($#Timer - 1)])));
    # total time
    return timestr(timediff($Timer[$#Timer],$Timer[0]));
\} # timing
\nwnotused{Common\ PERL\ subs\ -\ Benchmark}\nwendcode{}\nwbegindocs{46}\nwdocspar


\subsubsctn{Printing complex Data Structures}

With '{\tt{}Data::Dumper}' we are able to pretty print complex data structures for debugging them.


\nwenddocs{}\nwbegincode{47}\sublabel{NWblax-UseK-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-UseK-1}}}\moddef{Use Modules - Dumper~{\nwtagstyle{}\subpageref{NWblax-UseK-1}}}\endmoddef
use Data::Dumper;
local $Data::Dumper::Purity = 0;
local $Data::Dumper::Deepcopy = 1;
\nwnotused{Use\ Modules\ -\ Dumper}\nwendcode{}\nwbegindocs{48}\nwdocspar


\subsubsctn{Common functions}

\nwenddocs{}\nwbegincode{49}\sublabel{NWblax-SkiV-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-SkiV-1}}}\moddef{Skip comments and empty records~{\nwtagstyle{}\subpageref{NWblax-SkiV-1}}}\endmoddef
next if /^\\#/o;
next if /^\\s*$/o;
chomp;
\nwnotused{Skip\ comments\ and\ empty\ records}\nwendcode{}\nwbegindocs{50}\nwdocspar

\nwenddocs{}\nwbegincode{51}\sublabel{NWblax-ComQ-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-ComQ-1}}}\moddef{Common PERL subs - Min Max~{\nwtagstyle{}\subpageref{NWblax-ComQ-1}}}\endmoddef
#
sub max() \{
    my $z = shift @_;
    foreach my $l (@_) \{ $z = $l if $l > $z \};
    return $z;
\} # max
sub min() \{
    my $z = shift @_;
    foreach my $l (@_) \{ $z = $l if $l < $z \};
    return $z;
\} # min
\nwnotused{Common\ PERL\ subs\ -\ Min\ Max}\nwendcode{}\nwbegindocs{52}\nwdocspar

\nwenddocs{}\nwbegincode{53}\sublabel{NWblax-ComS.2-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-ComS.2-1}}}\moddef{Common PERL subs - Text fill~{\nwtagstyle{}\subpageref{NWblax-ComS.2-1}}}\endmoddef
#
sub fill_right() \{ $_[0].($_[2] x ($_[1] - length($_[0]))) \}
sub fill_left()  \{ ($_[2] x ($_[1] - length($_[0]))).$_[0] \}
sub fill_mid()   \{ 
    my $l = length($_[0]);
    my $k = int(($_[1] - $l)/2);
    ($_[2] x $k).$_[0].($_[2] x ($_[1] - ($l+$k)));
\} # fill_mid
\nwnotused{Common\ PERL\ subs\ -\ Text\ fill}\nwendcode{}\nwbegindocs{54}\nwdocspar

These functions are used to report to STDERR a single char for each record processed (useful for reporting parsed records).

\nwenddocs{}\nwbegincode{55}\sublabel{NWblax-ComQ.2-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-ComQ.2-1}}}\moddef{Common PERL subs - Counter~{\nwtagstyle{}\subpageref{NWblax-ComQ.2-1}}}\endmoddef
#
sub counter \{ # $_[0]~current_pos++ $_[1]~char
    print STDERR "$_[1]";
    (($_[0] % 50) == 0) && (print STDERR "[".&fill_left($_[0],6,"0")."]\\n");
\} # counter
#
sub counter_end \{ # $_[0]~current_pos   $_[1]~char
    (($_[0] % 50) != 0) && (print STDERR "[".&fill_left($_[0],6,"0")."]\\n");
\} # counter_end
\nwnotused{Common\ PERL\ subs\ -\ Counter}\nwendcode{}\nwbegindocs{56}\nwdocspar

\nwenddocs{}\nwbegincode{57}\sublabel{NWblax-GloL-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-GloL-1}}}\moddef{Global Vars - Counter~{\nwtagstyle{}\subpageref{NWblax-GloL-1}}}\endmoddef
my ($n,$c); # counter and char (for &counter function)
\eatline
\nwnotused{Global\ Vars\ -\ Counter}\nwendcode{}\nwbegindocs{58}\nwdocspar

\subsubsctn{Common functions for reporting program processes}
\label{sec:messagerpt}

Function '{\tt{}report}' requires that a hash variable '{\tt{}{\char37}MessageList}' has been set, such hash contains the strings for each report message we will need. The first parameter for '{\tt{}report}' is a key for that hash, in order to retrieve the message string, the other parameters passed are processed by the {\tt{}sprintf} function on that string.

\nwenddocs{}\nwbegincode{59}\sublabel{NWblax-ComP-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-ComP-1}}}\moddef{Common PERL subs - STDERR~{\nwtagstyle{}\subpageref{NWblax-ComP-1}}}\endmoddef
sub report() \{ print STDERR sprintf($MessageList\{ shift @_ \},@_) \}
\nwalsodefined{\\{NWblax-ComP-2}}\nwnotused{Common\ PERL\ subs\ -\ STDERR}\nwendcode{}\nwbegindocs{60}\nwdocspar

The same happens to '{\tt{}warn}' function which also requires a hash variable '{\tt{}{\char37}ErrorList}' containing the error messages.

\nwenddocs{}\nwbegincode{61}\sublabel{NWblax-ComP-2}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-ComP-2}}}\moddef{Common PERL subs - STDERR~{\nwtagstyle{}\subpageref{NWblax-ComP-1}}}\plusendmoddef
sub warn() \{ print STDERR sprintf($ErrorList\{ shift @_ \}, @_) \}
\nwendcode{}\nwbegindocs{62}\nwdocspar

\subsctn{BASH scripts}

\nwenddocs{}\nwbegincode{63}\sublabel{NWblax-BASC-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-BASC-1}}}\moddef{BASH shebang~{\nwtagstyle{}\subpageref{NWblax-BASC-1}}}\endmoddef
#!/usr/bin/bash
# GNU bash, version 2.03.6(1)-release (i386-redhat-linux-gnu)
\LA{}Version Control Id Tag~{\nwtagstyle{}\subpageref{NWblax-VerM-1}}\RA{}
#
SECONDS=0 # Reset Timing
# Which script are we running...
L="####################"
\{ echo "$L$L$L$L";
  echo "### RUNNING [$0]";
  echo "### Current date:`date`";
  echo "###"; \} 1>&2;
\nwused{\\{NWblax-wea7-1}\\{NWblax-LaT8-1}}\nwendcode{}\nwbegindocs{64}\nwdocspar

\nwenddocs{}\nwbegincode{65}\sublabel{NWblax-BASF-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-BASF-1}}}\moddef{BASH script end~{\nwtagstyle{}\subpageref{NWblax-BASF-1}}}\endmoddef
\{ echo "###"; echo "### Execution time for [$0] : $SECONDS secs";
  echo "$L$L$L$L";
  echo ""; \} 1>&2;
#
exit 0
\nwused{\\{NWblax-wea7-1}\\{NWblax-LaT8-1}}\nwendcode{}\nwbegindocs{66}\nwdocspar

\subsctn{Version control tags}

This document is under Revision Control System (RCS). The version you are currently reading is the following:

\nwenddocs{}\nwbegincode{67}\sublabel{NWblax-VerM-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-VerM-1}}}\moddef{Version Control Id Tag~{\nwtagstyle{}\subpageref{NWblax-VerM-1}}}\endmoddef
# $Id: blat2gff.tex,v 1.1 2001-10-22 14:44:13 jabril Exp $
\nwused{\\{NWblax-PERC-1}\\{NWblax-BASC-1}}\nwendcode{}\nwbegindocs{68}\nwdocspar

\subsctn{GNU General Public License}

\nwenddocs{}\nwbegincode{69}\sublabel{NWblax-GNUB-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-GNUB-1}}}\moddef{GNU License~{\nwtagstyle{}\subpageref{NWblax-GNUB-1}}}\endmoddef
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
# 
# #----------------------------------------------------------------#
\nwused{\\{NWblax-PERC-1}}\nwendcode{}\nwbegindocs{70}\nwdocspar

\newpage %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\sctn{Extracting code blocks from this document}

From this file we can obtain both the code and the
documentation. The following instructions are needed:

\subsctn{Extracts Script code chunks from the {\noweb} file} % \\[-0.5ex]

Remember when tangling that '-L' option allows you to include program line-numbering relative to original {\noweb} file. Then the first line of the executable files is a comment, not a shebang, and must be removed to make scripts runnable.

\nwenddocs{}\nwbegincode{71}\sublabel{NWblax-tan8-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-tan8-1}}}\moddef{tangling~{\nwtagstyle{}\subpageref{NWblax-tan8-1}}}\endmoddef
# showing line numbering comments in program
notangle -L -R"blat2gff" $WORK/$nwfile.nw | \\
    perl -ne '$.>1 && print' | cpif $BIN/blat2gff.pl ;
chmod a+x $BIN/blat2gff.pl ;
\nwalsodefined{\\{NWblax-tan8-2}\\{NWblax-tan8-3}\\{NWblax-tan8-4}\\{NWblax-tan8-5}}\nwnotused{tangling}\nwendcode{}\nwbegindocs{72}\nwdocspar

\nwenddocs{}\nwbegincode{73}\sublabel{NWblax-tan8-2}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-tan8-2}}}\moddef{tangling~{\nwtagstyle{}\subpageref{NWblax-tan8-1}}}\plusendmoddef
# reformating program with perltidy
notangle -R"blat2gff" $WORK/$nwfile.nw | \\
    perltidy - | cpif $BIN/blat2gff.pl ;
# html pretty-printing program with perltidy
notangle -R"blat2gff" $WORK/$nwfile.nw | \\
    perltidy -html - | cpif $DOCS/html/blat2gff.html ;
#
\nwendcode{}\nwbegindocs{74}\nwdocspar

\subsctn{Extracting different Config Files} % \\[-0.5ex]

\nwenddocs{}\nwbegincode{75}\sublabel{NWblax-tan8-3}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-tan8-3}}}\moddef{tangling~{\nwtagstyle{}\subpageref{NWblax-tan8-1}}}\plusendmoddef
notangle -R"BLAT output example" $WORK/$nwfile.nw | \\
         cpif $DATA/output.blat ;
\nwendcode{}\nwbegindocs{76}%$

\subsctn{Extracting documentation and \LaTeX{}'ing it} % \\[-0.5ex] %'

\nwenddocs{}\nwbegincode{77}\sublabel{NWblax-tan8-4}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-tan8-4}}}\moddef{tangling~{\nwtagstyle{}\subpageref{NWblax-tan8-1}}}\plusendmoddef
notangle -Rweaving  $WORK/$nwfile.nw | cpif $WORK/nw2tex ;
notangle -RLaTeXing $WORK/$nwfile.nw | cpif $WORK/ltx ;
chmod a+x $WORK/nw2tex $WORK/ltx;
\nwendcode{}\nwbegindocs{78}\nwdocspar

\nwenddocs{}\nwbegincode{79}\sublabel{NWblax-tanY-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-tanY-1}}}\moddef{tangling complementary LaTeX files~{\nwtagstyle{}\subpageref{NWblax-tanY-1}}}\endmoddef
notangle -R"HIDE: LaTeX new definitions" $WORK/$nwfile.nw | cpif $DOCS/defs.tex ;
notangle -R"HIDE: TODO" $WORK/$nwfile.nw | cpif $DOCS/todo.tex ; 
\nwused{\\{NWblax-wea7-1}}\nwendcode{}\nwbegindocs{80}\nwdocspar

\nwenddocs{}\nwbegincode{81}\sublabel{NWblax-wea7-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-wea7-1}}}\moddef{weaving~{\nwtagstyle{}\subpageref{NWblax-wea7-1}}}\endmoddef
\LA{}BASH shebang~{\nwtagstyle{}\subpageref{NWblax-BASC-1}}\RA{}
# weaving and LaTeXing
\LA{}BASH Environment Variables~{\nwtagstyle{}\subpageref{NWblax-BASQ-1}}\RA{}
\LA{}tangling complementary LaTeX files~{\nwtagstyle{}\subpageref{NWblax-tanY-1}}\RA{}
noweave -v -t4 -delay -x -filter 'elide "HIDE: *"' \\
        $WORK/$nwfile.nw | cpif $DOCS/$nwfile.tex ;
# noweave -t4 -delay -index $WORK/$nwfile.nw > $DOCS/$nwfile.tex 
pushd $DOCS/ ;
#
latex $nwfile.tex ;
dvips $nwfile.dvi -o $nwfile.ps -t a4 ;
#
popd;
\LA{}BASH script end~{\nwtagstyle{}\subpageref{NWblax-BASF-1}}\RA{}
\nwnotused{weaving}\nwendcode{}\nwbegindocs{82}\nwdocspar

\nwenddocs{}\nwbegincode{83}\sublabel{NWblax-LaT8-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-LaT8-1}}}\moddef{LaTeXing~{\nwtagstyle{}\subpageref{NWblax-LaT8-1}}}\endmoddef
\LA{}BASH shebang~{\nwtagstyle{}\subpageref{NWblax-BASC-1}}\RA{}
# only LaTeXing
\LA{}BASH Environment Variables~{\nwtagstyle{}\subpageref{NWblax-BASQ-1}}\RA{}
pushd $DOCS/ ;
#
echo "### RUNNING LaTeX on $nwfile.tex" 1>&2 ;
latex $nwfile.tex ; 
latex $nwfile.tex ; 
latex $nwfile.tex ;
dvips $nwfile.dvi -o $nwfile.ps -t a4 ;
#
# pdflatex $nwfile.tex ;
echo "### CONVERTING PS to PDF: $nwfile" 1>&2 ;
ps2pdf $nwfile.ps $nwfile.pdf ;
#
popd ;
\LA{}BASH script end~{\nwtagstyle{}\subpageref{NWblax-BASF-1}}\RA{}
\nwnotused{LaTeXing}\nwendcode{}\nwbegindocs{84}%$

\subsctn{Defining working shell variables for the current project} % \\[-0.5ex]

\nwenddocs{}\nwbegincode{85}\sublabel{NWblax-BASQ-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-BASQ-1}}}\moddef{BASH Environment Variables~{\nwtagstyle{}\subpageref{NWblax-BASQ-1}}}\endmoddef
#
# Setting Global Variables
WORK="/home/ug/jabril/development/softjabril/blat2gff" ;
BIN="$WORK/bin" ;
PARAM="$BIN/param" ;
DOCS="$WORK/docs" ;
DATA="$WORK/data" ;
nwfile="blat2gff" ;
export WORK BIN PARAM DOCS DATA nwfile ;
#
\nwused{\\{NWblax-wea7-1}\\{NWblax-LaT8-1}}\nwendcode{}\nwbegindocs{86}\nwdocspar

\nwenddocs{}\nwbegincode{87}\sublabel{NWblax-tan8-5}\nwmargintag{{\nwtagstyle{}\subpageref{NWblax-tan8-5}}}\moddef{tangling~{\nwtagstyle{}\subpageref{NWblax-tan8-1}}}\plusendmoddef
# 
# BASH Environment Variables
notangle -R'BASH Environment Variables' $WORK/$nwfile.nw | \\
         cpif $WORK/.bash_VARS ; 
source $WORK/.bash_VARS ;
#
\nwendcode{}

\nwixlogsorted{c}{{BASH Environment Variables}{NWblax-BASQ-1}{\nwixu{NWblax-wea7-1}\nwixu{NWblax-LaT8-1}\nwixd{NWblax-BASQ-1}}}%
\nwixlogsorted{c}{{BASH script end}{NWblax-BASF-1}{\nwixd{NWblax-BASF-1}\nwixu{NWblax-wea7-1}\nwixu{NWblax-LaT8-1}}}%
\nwixlogsorted{c}{{BASH shebang}{NWblax-BASC-1}{\nwixd{NWblax-BASC-1}\nwixu{NWblax-wea7-1}\nwixu{NWblax-LaT8-1}}}%
\nwixlogsorted{c}{{BLAT output example}{NWblax-BLAJ-1}{\nwixd{NWblax-BLAJ-1}}}%
\nwixlogsorted{c}{{Common PERL subs - Benchmark}{NWblax-ComS-1}{\nwixd{NWblax-ComS-1}}}%
\nwixlogsorted{c}{{Common PERL subs - Counter}{NWblax-ComQ.2-1}{\nwixd{NWblax-ComQ.2-1}}}%
\nwixlogsorted{c}{{Common PERL subs - Min Max}{NWblax-ComQ-1}{\nwixd{NWblax-ComQ-1}}}%
\nwixlogsorted{c}{{Common PERL subs - STDERR}{NWblax-ComP-1}{\nwixd{NWblax-ComP-1}\nwixd{NWblax-ComP-2}}}%
\nwixlogsorted{c}{{Common PERL subs - Text fill}{NWblax-ComS.2-1}{\nwixd{NWblax-ComS.2-1}}}%
\nwixlogsorted{c}{{Functions}{NWblax-Fun9-1}{\nwixu{NWblax-bla8-1}\nwixd{NWblax-Fun9-1}\nwixd{NWblax-Fun9-2}}}%
\nwixlogsorted{c}{{GNU License}{NWblax-GNUB-1}{\nwixu{NWblax-PERC-1}\nwixd{NWblax-GNUB-1}}}%
\nwixlogsorted{c}{{Global Constants - Boolean}{NWblax-GloQ-1}{\nwixd{NWblax-GloQ-1}}}%
\nwixlogsorted{c}{{Global Vars}{NWblax-GloB-1}{\nwixu{NWblax-bla8-1}\nwixd{NWblax-GloB-1}\nwixd{NWblax-GloB-2}}}%
\nwixlogsorted{c}{{Global Vars - Counter}{NWblax-GloL-1}{\nwixd{NWblax-GloL-1}}}%
\nwixlogsorted{c}{{HIDE: LaTeX new definitions}{NWblax-HIDR-1}{\nwixd{NWblax-HIDR-1}}}%
\nwixlogsorted{c}{{HIDE: TODO}{NWblax-HIDA-1}{\nwixd{NWblax-HIDA-1}}}%
\nwixlogsorted{c}{{HIDE: new LaTeX commands}{NWblax-HIDO-1}{\nwixu{NWblax-HIDR-1}\nwixd{NWblax-HIDO-1}}}%
\nwixlogsorted{c}{{HIDE: new LaTeX definitions}{NWblax-HIDR.2-1}{\nwixu{NWblax-HIDR-1}\nwixd{NWblax-HIDR.2-1}}}%
\nwixlogsorted{c}{{HIDE: new LaTeX pstricks}{NWblax-HIDO.2-1}{\nwixu{NWblax-HIDR-1}\nwixd{NWblax-HIDO.2-1}}}%
\nwixlogsorted{c}{{HIDE: new LaTeX urls}{NWblax-HIDK-1}{\nwixu{NWblax-HIDR-1}\nwixd{NWblax-HIDK-1}}}%
\nwixlogsorted{c}{{HIDE: new defs TODO}{NWblax-HIDJ-1}{\nwixu{NWblax-HIDR-1}\nwixd{NWblax-HIDJ-1}\nwixd{NWblax-HIDJ-2}}}%
\nwixlogsorted{c}{{LaTeXing}{NWblax-LaT8-1}{\nwixd{NWblax-LaT8-1}}}%
\nwixlogsorted{c}{{Main Loop}{NWblax-Mai9-1}{\nwixu{NWblax-bla8-1}\nwixd{NWblax-Mai9-1}}}%
\nwixlogsorted{c}{{PERL shebang}{NWblax-PERC-1}{\nwixu{NWblax-bla8-1}\nwixd{NWblax-PERC-1}}}%
\nwixlogsorted{c}{{Program Description}{NWblax-ProJ-1}{\nwixd{NWblax-ProJ-1}\nwixu{NWblax-PERC-1}}}%
\nwixlogsorted{c}{{Program Info}{NWblax-ProC-1}{\nwixd{NWblax-ProC-1}\nwixu{NWblax-PERC-1}}}%
\nwixlogsorted{c}{{Skip comments and empty records}{NWblax-SkiV-1}{\nwixd{NWblax-SkiV-1}}}%
\nwixlogsorted{c}{{Timer ON}{NWblax-Tim8-1}{\nwixu{NWblax-UseN-1}\nwixd{NWblax-Tim8-1}}}%
\nwixlogsorted{c}{{Use Modules}{NWblax-UseB-1}{\nwixu{NWblax-bla8-1}\nwixd{NWblax-UseB-1}}}%
\nwixlogsorted{c}{{Use Modules - Benchmark}{NWblax-UseN-1}{\nwixd{NWblax-UseN-1}}}%
\nwixlogsorted{c}{{Use Modules - Dumper}{NWblax-UseK-1}{\nwixd{NWblax-UseK-1}}}%
\nwixlogsorted{c}{{Version Control Id Tag}{NWblax-VerM-1}{\nwixu{NWblax-PERC-1}\nwixu{NWblax-BASC-1}\nwixd{NWblax-VerM-1}}}%
\nwixlogsorted{c}{{blat2gff}{NWblax-bla8-1}{\nwixd{NWblax-bla8-1}}}%
\nwixlogsorted{c}{{tangling}{NWblax-tan8-1}{\nwixd{NWblax-tan8-1}\nwixd{NWblax-tan8-2}\nwixd{NWblax-tan8-3}\nwixd{NWblax-tan8-4}\nwixd{NWblax-tan8-5}}}%
\nwixlogsorted{c}{{tangling complementary LaTeX files}{NWblax-tanY-1}{\nwixd{NWblax-tanY-1}\nwixu{NWblax-wea7-1}}}%
\nwixlogsorted{c}{{weaving}{NWblax-wea7-1}{\nwixd{NWblax-wea7-1}}}%
\nwbegindocs{88}\nwdocspar

%
\end{document}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\nwenddocs{}
